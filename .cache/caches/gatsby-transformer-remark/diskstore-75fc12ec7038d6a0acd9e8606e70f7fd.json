{"expireTime":9007200839305450000,"key":"transformer-remark-markdown-html-d91da1ce0214a774be2820fd612d8253-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypants-","val":"<p>I was looking for a way to put data in my database. I wanted something that was\norganized and simple like a Rails migration, but also agreed with Node. To my\nsuprise, NPM didnâ€™t have many of packages to choose from. I considered\nSerialize, but wound up using <a href=\"http://knexjs.org/\">Knex</a> which made migrations a\npiece of cake.</p>\n<p>Weâ€™ll be seeding a database in this post, but Knex is a fully functioning query\nbuilder. It handles migrations and schema changes with elegance. If you want to\ngive it a spin you can try out some queries. Otherwise, letâ€™s get started.</p>\n<h2>Setting Up Knex</h2>\n<p>Open your command line application. Once youâ€™ve cdâ€™d into your project install\nKnex by running the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> knex --save</code></pre></div>\n<p>Now that knex is installed weâ€™re ready to generate a template knexfile.js by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">knex init</code></pre></div>\n<p>This command creates a knexfile.js in your project. All your database\nconfigurations are housed in this file. There are different blocks for your\ndevelopment, staging and production configs which reduces some environment\ncomplexities. Youâ€™ll probably want to use environment variables if you plan on\npushing this to production. Otherwise, youâ€™ll be fine just hardcoding your\nconnection data. Below you can see how mine looks.</p>\n<h2>Configuring Knex</h2>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  development<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    client<span class=\"token operator\">:</span> <span class=\"token string\">'postgresql'</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token operator\">:</span> <span class=\"token string\">'postgresql://localhost/your_database'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  production<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    client<span class=\"token operator\">:</span> <span class=\"token string\">'postgresql'</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      host<span class=\"token operator\">:</span> 'your_hostâ€™<span class=\"token punctuation\">,</span>\n      database<span class=\"token operator\">:</span> â€™your_database_nameâ€™<span class=\"token punctuation\">,</span>\n      user<span class=\"token operator\">:</span> â€˜your_database_userâ€™'<span class=\"token punctuation\">,</span>\n      password<span class=\"token operator\">:</span> 'your_database_passwordâ€™\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pool<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      min<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      max<span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    migrations<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      tableName<span class=\"token operator\">:</span> <span class=\"token string\">'knex_migrations'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Creating a Table Migration</h2>\n<p>Once youâ€™ve added your database config values we can create our first migration.\nLetâ€™s run a command to create a table. In this example, we will set up a users\ntable. Run the following from the command line.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">knex migrate:make create_users_table</code></pre></div>\n<p>You should see a new folder called migrations. Inside this folder youâ€™ll have a\nfile named <code class=\"language-text\">create_users_table</code>. Weâ€™ll specify our columns in this file shortly.\nBut first Iâ€™d like to point out the long number at the beginning of the file\nname. In short, this number allows the files to be run in the order they were\ngenerated, which prevents nasty foreign key errors. Yay!</p>\n<p>Letâ€™s take a look inside the new <code class=\"language-text\">create_users_table</code> file we generated. Youâ€™ll\nnotice an exports up and exports down. The exports up will hold the code that\ncreates the table and the exports down will house the code that deletes the\ntable. Now letâ€™s write some code inside these sections.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">up</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">knex<span class=\"token punctuation\">,</span> Promise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  knex<span class=\"token punctuation\">.</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">createTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">table</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">increments</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNullable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">primary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">boolean</span><span class=\"token punctuation\">(</span><span class=\"token string\">'active'</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">timestamp</span><span class=\"token punctuation\">(</span><span class=\"token string\">'created_at'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultTo</span><span class=\"token punctuation\">(</span>knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">'email'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNullable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unique</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">'first_name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNullable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">'last_name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNullable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    table<span class=\"token punctuation\">.</span><span class=\"token function\">timestamp</span><span class=\"token punctuation\">(</span><span class=\"token string\">'updated_at'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultTo</span><span class=\"token punctuation\">(</span>knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">down</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">knex<span class=\"token punctuation\">,</span> Promise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> knex<span class=\"token punctuation\">.</span>schema<span class=\"token punctuation\">.</span><span class=\"token function\">dropTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Running Our Table Migration</h3>\n<p>Itâ€™s important to note that code to generate our users table is javascript, but\nwill be interpreted as SQL when we run the migration. In my opinion JS is easier\nto read than a straight SQL migration. Especially since Knex allows us to use\nmethods like notNullable() and defaultTo() and unique(). So with these few lines\nof JavaScript we can generate or delete our table entirely from the command line.</p>\n<p>Now that we have the migration written running it only takes a few keystrokes.\nMake sure your database is started and run the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">knex migrate:latest</code></pre></div>\n<h3>Creating Our Seed File</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">knex seed:make add_users</code></pre></div>\n<p>This will give us a file sort of similar to the first one we generated. Instead\nof an exports up and down, this file will just contain a seed export. Letâ€™s move\non and write some code to make our users.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">seed</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">knex<span class=\"token punctuation\">,</span> Promise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// Deletes ALL existing entries</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">knex</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">del</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Inserts seed entries</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">knex</span><span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        active<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        created_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        email<span class=\"token operator\">:</span> bugsbunnyboi@example<span class=\"token punctuation\">.</span>com'<span class=\"token punctuation\">,</span>\n        first_name<span class=\"token operator\">:</span> <span class=\"token string\">'Bugs'</span><span class=\"token punctuation\">,</span>\n        last_name<span class=\"token operator\">:</span> <span class=\"token string\">'Bunny'</span><span class=\"token punctuation\">,</span>\n        updated_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        active<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        created_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        email<span class=\"token operator\">:</span> <span class=\"token string\">'yosemitesammy@example.com'</span><span class=\"token punctuation\">,</span>\n        first_name<span class=\"token operator\">:</span> <span class=\"token string\">'Yosemite'</span><span class=\"token punctuation\">,</span>\n        last_name<span class=\"token operator\">:</span> <span class=\"token string\">'Sam'</span><span class=\"token punctuation\">,</span>\n        updated_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        active<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        created_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        email<span class=\"token operator\">:</span> <span class=\"token string\">'marvinthemarty@example.com'</span><span class=\"token punctuation\">,</span>\n        first_name<span class=\"token operator\">:</span> <span class=\"token string\">'Marvin'</span><span class=\"token punctuation\">,</span>\n        last_name<span class=\"token operator\">:</span> <span class=\"token string\">'Martian'</span><span class=\"token punctuation\">,</span>\n        updated_at<span class=\"token operator\">:</span> knex<span class=\"token punctuation\">.</span>fn<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Running Our Seed File</h3>\n<p>This code will insert three users to our database. Letâ€™s try it out by doing:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">knex seed:run</code></pre></div>\n<h3>We Seeded Our DB with Knex</h3>\n<p>If all goes as planned we should have three new users ðŸŽ‰. As you can see, Knex\nis designed to keep migrations tidy. In turn this simplifies schema changes and\neliminates foreign key conflicts. All in all that means more time to code features.</p>"}